<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Position Sizing Wizard</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Position Sizing Wizard</h1>
        <form method="POST" action="/">
            <div class="form-group">
                <label for="high">Candle High:</label>
                <input type="number" id="high" name="high" required step="any">
            </div>
            
            <div class="form-group">
                <label for="low">Candle Low:</label>
                <input type="number" id="low" name="low" required step="any">
            </div>
    
            <div class="form-group">
                <label for="risk">Risk Amount:</label>
                <input type="number" id="risk" name="risk" required step="any">
            </div>
            
            <button type="submit">Calculate</button>
        </form>
        
        {% if error_message %}
        <p style="color: red;">Error: {{ error_message }}</p>
        {% elif result %}
        <div class="result" id="result-container">
            <div id="result-content">
                <h3>Calculation Results:</h3>
                <p><strong>Candle High:</strong> {{ result.high }}</p>
                <p><strong>Candle Low:</strong> {{ result.low }}</p>
                <p><strong>Enter Position At:</strong> {{ result.enter_position }}$</p>
                <p><strong>Stop Loss At:</strong> {{ result.stop_loss }}$</p>
                <p><strong>Buy Amount of Stocks:</strong> {{ result.stock_amount }}</p>
                <p><strong>Total Deal Cost:</strong> {{ result.deal_cost }}$</p>
            </div>
            <div class="button-container">
                <button type="button" class="button-nav" id="back-btn" onclick="navigate('backward')" disabled>⬅</button>
                <button class="close-btn" onclick="closeResult()">x</button>
                <button type="button" class="button-nav" id="forward-btn" onclick="navigate('forward')" disabled>➡</button>
            </div>
        </div>
        {% endif %}
    </div>
    
    <script>
        let currentIndex = 0; // Track the current result index
        const username = "{{ session.get('username', '') }}"; // Get session username safely
    
        function updateNavigationButtons(totalResults) {
            document.getElementById('back-btn').disabled = (currentIndex === 0);
            document.getElementById('forward-btn').disabled = (currentIndex >= totalResults - 1);
        }
    
        function navigate(direction) {
        console.log(`Navigating: ${direction}`); // Debugging log
        fetch(`/navigate?direction=${direction}&current_index=${currentIndex}`)
            .then(response => response.json())
            .then(data => {
                console.log("Response from server:", data); // Debugging log
                if (data.result) {
                    document.getElementById('result-container').style.display = 'block';
                    document.getElementById('result-content').innerHTML = `
                        <h3>Calculation Results:</h3>
                        <p><strong>Candle High:</strong> ${data.result.high}</p>
                        <p><strong>Candle Low:</strong> ${data.result.low}</p>
                        <p><strong>Enter Position At:</strong> ${data.result.enter_position}$</p>
                        <p><strong>Stop Loss At:</strong> ${data.result.stop_loss}$</p>
                        <p><strong>Buy Amount of Stocks:</strong> ${data.result.stock_amount}</p>
                        <p><strong>Total Deal Cost:</strong> ${data.result.deal_cost}$</p>
                        <p><strong>Date:</strong> ${data.date}</p>
                    `;
                    currentIndex = data.new_index;
                    updateNavigationButtons(data.totalResults);
                } else {
                    console.error("Error from server:", data.error);
                }
            })
            .catch(error => console.error("Fetch error:", error));
    }
    
        // Fetch total results count on page load
        window.onload = function () {
            if (username) {
                fetch(`/total_results?username=${username}`)
                    .then(response => response.json())
                    .then(data => {
                        currentIndex = data.currentIndex || 0;
                        updateNavigationButtons(data.totalResults || 0);
                    })
                    .catch(error => console.error("Error fetching total results:", error));
            }
        };
    
        function closeResult() {
            document.getElementById('result-container').style.display = 'none';
        }
    </script>
</body>
</html>